#!/bin/sh

_valgrind() {
    if command -v valgrind >/dev/null 2>&1; then
        valgrind \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --error-exitcode=1 \
            "$@"
    else
        "$@"
    fi
}

check() {
    set -e

    for file in test/*.c; do
        _valgrind "${file%%.c}"
    done

    _valgrind ./kiss v
    _valgrind ./kiss
}

check
